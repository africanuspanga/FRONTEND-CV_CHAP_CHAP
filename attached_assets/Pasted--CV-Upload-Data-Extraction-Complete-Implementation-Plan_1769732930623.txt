# CV Upload & Data Extraction - Complete Implementation Plan

## Overview

This feature allows users to upload an existing CV (PDF/DOCX) and automatically extract all information into our builder, saving them significant time.

---

## User Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CV UPLOAD & EXTRACTION FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ENTRY POINTS (User can start from):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Option A: Homepage
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  "Create Your CV"     "Upload Existing" â”‚
â”‚      [Button]            [Button]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
Option B: Template Selection Page
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  "Have an existing CV?"                 â”‚
â”‚  [Upload & Auto-fill] â† subtle link     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
UPLOAD FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Step 1: SELECT TEMPLATE FIRST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Choose a template for your new CV      â”‚
â”‚  (Your data will be extracted into it)  â”‚
â”‚                                         â”‚
â”‚  [21 template thumbnails]               â”‚
â”‚                                         â”‚
â”‚  [Continue â†’]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 2: UPLOAD FILE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                               â”‚    â”‚
â”‚    â”‚   ğŸ“„ Drop your CV here        â”‚    â”‚
â”‚    â”‚                               â”‚    â”‚
â”‚    â”‚   or click to browse          â”‚    â”‚
â”‚    â”‚                               â”‚    â”‚
â”‚    â”‚   PDF or DOCX â€¢ Max 5MB       â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚    âš¡ AI will extract your details      â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 3: PROCESSING (5-15 seconds)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚         â³ Extracting your CV...        â”‚
â”‚                                         â”‚
â”‚    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 60%           â”‚
â”‚                                         â”‚
â”‚    âœ“ Reading document                   â”‚
â”‚    âœ“ Extracting personal info           â”‚
â”‚    â— Finding work experience...         â”‚
â”‚    â—‹ Identifying skills                 â”‚
â”‚    â—‹ Parsing education                  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 4: REVIEW EXTRACTED DATA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  We found the following information:    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ âœ“ Personal Info      [Review]   â”‚    â”‚
â”‚  â”‚   Noela Bwemero, +255 754...    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ âœ“ 3 Work Experiences [Review]   â”‚    â”‚
â”‚  â”‚   Mkono & Co, CRDB Bank...      â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ âœ“ 2 Education Items  [Review]   â”‚    â”‚
â”‚  â”‚   LL.M, LL.B                    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ âœ“ 12 Skills Found    [Review]   â”‚    â”‚
â”‚  â”‚   Corporate Law, M&A...         â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ âš  Summary            [Add]      â”‚    â”‚
â”‚  â”‚   Not found - AI can generate   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  [â† Upload Different]  [Use This Data â†’]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 5: ENTER BUILDER AT PERSONAL INFO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  All fields pre-filled!                 â”‚
â”‚  Review and edit as needed.             â”‚
â”‚                                         â”‚
â”‚  Personal Info â†’ Experience â†’ ...       â”‚
â”‚                                         â”‚
â”‚  User can navigate to ANY section       â”‚
â”‚  and edit the extracted data            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 6: FINAL PREVIEW
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Complete CV with all extracted +       â”‚
â”‚  edited data in chosen template         â”‚
â”‚                                         â”‚
â”‚  [â† Edit Sections]  [Download PDF â†’]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXTRACTION PIPELINE                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  User Upload â”‚
                    â”‚  (PDF/DOCX)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     FILE TYPE DETECTION      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PDF Parser    â”‚      â”‚   DOCX Parser   â”‚
    â”‚   (pdf-parse)   â”‚      â”‚   (mammoth)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      RAW TEXT OUTPUT         â”‚
            â”‚  (Unstructured text blob)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     OPENAI GPT-4 TURBO       â”‚
            â”‚                              â”‚
            â”‚  Structured extraction with  â”‚
            â”‚  JSON schema enforcement     â”‚
            â”‚                              â”‚
            â”‚  - Personal Info             â”‚
            â”‚  - Work Experiences []       â”‚
            â”‚  - Education []              â”‚
            â”‚  - Skills []                 â”‚
            â”‚  - Languages []              â”‚
            â”‚  - Certifications []         â”‚
            â”‚  - Summary                   â”‚
            â”‚  - References []             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    VALIDATION & CLEANUP      â”‚
            â”‚                              â”‚
            â”‚  - Normalize phone formats   â”‚
            â”‚  - Validate email            â”‚
            â”‚  - Parse dates consistently  â”‚
            â”‚  - Remove duplicates         â”‚
            â”‚  - Assign unique IDs         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     ZUSTAND STORE UPDATE     â”‚
            â”‚                              â”‚
            â”‚  cvData = extractedData      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Tasks

### Task 1: Install Dependencies

```bash
npm install pdf-parse mammoth uuid
npm install -D @types/pdf-parse
```

---

### Task 2: Create Extraction API Route

**`src/app/api/cv/extract/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';
import pdfParse from 'pdf-parse';
import mammoth from 'mammoth';
import { v4 as uuidv4 } from 'uuid';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Types for extracted data
interface ExtractedCV {
  personalInfo: {
    firstName: string;
    lastName: string;
    email: string;
    phone: string;
    location: string;
    professionalTitle: string;
    linkedin: string;
    website: string;
  };
  summary: string;
  workExperiences: Array<{
    id: string;
    jobTitle: string;
    company: string;
    location: string;
    startDate: string;
    endDate: string;
    isCurrent: boolean;
    achievements: string[];
  }>;
  education: Array<{
    id: string;
    degree: string;
    institution: string;
    fieldOfStudy: string;
    graduationDate: string;
    location: string;
    gpa?: string;
  }>;
  skills: Array<{
    id: string;
    name: string;
    level: 'beginner' | 'intermediate' | 'advanced' | 'expert';
  }>;
  languages: Array<{
    id: string;
    name: string;
    proficiency: 'basic' | 'conversational' | 'fluent' | 'native';
  }>;
  certifications: Array<{
    id: string;
    name: string;
    issuer: string;
    date: string;
  }>;
  references: Array<{
    id: string;
    name: string;
    position: string;
    company: string;
    email: string;
    phone: string;
    relationship: string;
  }>;
  extractionConfidence: {
    personalInfo: number;
    workExperiences: number;
    education: number;
    skills: number;
    overall: number;
  };
}

// Extract text from PDF
async function extractFromPDF(buffer: Buffer): Promise<string> {
  try {
    const data = await pdfParse(buffer);
    return data.text;
  } catch (error) {
    console.error('PDF parsing error:', error);
    throw new Error('Failed to parse PDF file');
  }
}

// Extract text from DOCX
async function extractFromDOCX(buffer: Buffer): Promise<string> {
  try {
    const result = await mammoth.extractRawText({ buffer });
    return result.value;
  } catch (error) {
    console.error('DOCX parsing error:', error);
    throw new Error('Failed to parse DOCX file');
  }
}

// Use OpenAI to structure the extracted text
async function structureWithAI(rawText: string): Promise<ExtractedCV> {
  const systemPrompt = `You are a CV/Resume data extraction expert. Your task is to extract structured information from CV text.

IMPORTANT RULES:
1. Extract ONLY information that is explicitly present in the text
2. Do NOT invent or assume any information
3. If a field is not found, use empty string "" or empty array []
4. For dates, use format "Month YYYY" (e.g., "January 2020")
5. For phone numbers, preserve the original format
6. Split full name into firstName and lastName
7. For skills, infer proficiency level based on context (years mentioned, "expert in", etc.)
8. For work achievements, keep each bullet point as a separate string
9. Identify if a job is "current" based on keywords like "Present", "Current", "Now", or no end date

EXTRACTION CONFIDENCE:
- Rate your confidence for each section from 0.0 to 1.0
- 1.0 = All information clearly found
- 0.5 = Some information found but incomplete
- 0.0 = Section not found at all`;

  const userPrompt = `Extract all CV information from the following text and return it as JSON.

CV TEXT:
"""
${rawText.substring(0, 15000)}
"""

Return a JSON object with this exact structure:
{
  "personalInfo": {
    "firstName": "",
    "lastName": "",
    "email": "",
    "phone": "",
    "location": "",
    "professionalTitle": "",
    "linkedin": "",
    "website": ""
  },
  "summary": "",
  "workExperiences": [
    {
      "jobTitle": "",
      "company": "",
      "location": "",
      "startDate": "",
      "endDate": "",
      "isCurrent": false,
      "achievements": ["", ""]
    }
  ],
  "education": [
    {
      "degree": "",
      "institution": "",
      "fieldOfStudy": "",
      "graduationDate": "",
      "location": "",
      "gpa": ""
    }
  ],
  "skills": [
    {
      "name": "",
      "level": "intermediate"
    }
  ],
  "languages": [
    {
      "name": "",
      "proficiency": "fluent"
    }
  ],
  "certifications": [
    {
      "name": "",
      "issuer": "",
      "date": ""
    }
  ],
  "references": [
    {
      "name": "",
      "position": "",
      "company": "",
      "email": "",
      "phone": "",
      "relationship": ""
    }
  ],
  "extractionConfidence": {
    "personalInfo": 0.0,
    "workExperiences": 0.0,
    "education": 0.0,
    "skills": 0.0,
    "overall": 0.0
  }
}

IMPORTANT: Return ONLY valid JSON, no markdown, no explanations.`;

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4-turbo-preview',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      temperature: 0.1, // Low temperature for consistent extraction
      max_tokens: 4000,
      response_format: { type: 'json_object' },
    });

    const content = response.choices[0]?.message?.content;
    if (!content) {
      throw new Error('Empty response from AI');
    }

    return JSON.parse(content);
  } catch (error) {
    console.error('AI extraction error:', error);
    throw new Error('Failed to extract CV information');
  }
}

// Add unique IDs and clean up data
function processExtractedData(data: ExtractedCV): ExtractedCV {
  return {
    ...data,
    personalInfo: {
      ...data.personalInfo,
      // Clean up phone number
      phone: data.personalInfo.phone?.replace(/[^\d+\-\s()]/g, '') || '',
      // Clean up email
      email: data.personalInfo.email?.toLowerCase().trim() || '',
    },
    workExperiences: (data.workExperiences || []).map((exp) => ({
      ...exp,
      id: uuidv4(),
      achievements: exp.achievements?.filter((a) => a && a.trim()) || [],
    })),
    education: (data.education || []).map((edu) => ({
      ...edu,
      id: uuidv4(),
    })),
    skills: (data.skills || []).map((skill) => ({
      ...skill,
      id: uuidv4(),
      level: skill.level || 'intermediate',
    })),
    languages: (data.languages || []).map((lang) => ({
      ...lang,
      id: uuidv4(),
      proficiency: lang.proficiency || 'conversational',
    })),
    certifications: (data.certifications || []).map((cert) => ({
      ...cert,
      id: uuidv4(),
    })),
    references: (data.references || []).slice(0, 2).map((ref) => ({
      ...ref,
      id: uuidv4(),
    })),
  };
}

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json(
        { error: 'No file provided' },
        { status: 400 }
      );
    }

    // Validate file type
    const allowedTypes = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    ];
    
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        { error: 'Invalid file type. Please upload PDF or DOCX.' },
        { status: 400 }
      );
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      return NextResponse.json(
        { error: 'File too large. Maximum size is 5MB.' },
        { status: 400 }
      );
    }

    // Convert file to buffer
    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);

    // Extract text based on file type
    let rawText: string;
    
    if (file.type === 'application/pdf') {
      rawText = await extractFromPDF(buffer);
    } else {
      rawText = await extractFromDOCX(buffer);
    }

    // Check if we got any text
    if (!rawText || rawText.trim().length < 50) {
      return NextResponse.json(
        { error: 'Could not extract text from file. Please ensure the CV contains readable text.' },
        { status: 400 }
      );
    }

    // Use AI to structure the data
    const extractedData = await structureWithAI(rawText);

    // Process and clean up the data
    const processedData = processExtractedData(extractedData);

    return NextResponse.json({
      success: true,
      data: processedData,
      rawTextLength: rawText.length,
    });

  } catch (error) {
    console.error('CV extraction error:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to extract CV' },
      { status: 500 }
    );
  }
}
```

---

### Task 3: Create Upload Component

**`src/components/cv-upload/upload-zone.tsx`**

```tsx
'use client';

import { useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { useCVStore } from '@/stores/cv-store';
import { Button } from '@/components/ui/button';

interface ExtractionProgress {
  stage: 'idle' | 'uploading' | 'parsing' | 'extracting' | 'processing' | 'complete' | 'error';
  message: string;
  percent: number;
}

export function CVUploadZone() {
  const router = useRouter();
  const { setCVData, templateId } = useCVStore();
  
  const [isDragging, setIsDragging] = useState(false);
  const [progress, setProgress] = useState<ExtractionProgress>({
    stage: 'idle',
    message: '',
    percent: 0,
  });
  const [error, setError] = useState<string | null>(null);
  const [extractedData, setExtractedData] = useState<any>(null);

  const processFile = async (file: File) => {
    setError(null);
    setExtractedData(null);

    // Validate file type
    const allowedTypes = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    ];
    
    if (!allowedTypes.includes(file.type)) {
      setError('Please upload a PDF or DOCX file');
      return;
    }

    // Validate file size
    if (file.size > 5 * 1024 * 1024) {
      setError('File is too large. Maximum size is 5MB.');
      return;
    }

    try {
      // Stage 1: Uploading
      setProgress({ stage: 'uploading', message: 'Uploading your CV...', percent: 10 });

      const formData = new FormData();
      formData.append('file', file);

      // Stage 2: Parsing
      setProgress({ stage: 'parsing', message: 'Reading document...', percent: 30 });

      const response = await fetch('/api/cv/extract', {
        method: 'POST',
        body: formData,
      });

      // Stage 3: Extracting
      setProgress({ stage: 'extracting', message: 'Extracting information with AI...', percent: 60 });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Extraction failed');
      }

      // Stage 4: Processing
      setProgress({ stage: 'processing', message: 'Organizing your data...', percent: 90 });

      // Small delay for UX
      await new Promise((resolve) => setTimeout(resolve, 500));

      // Stage 5: Complete
      setProgress({ stage: 'complete', message: 'Extraction complete!', percent: 100 });
      setExtractedData(result.data);

    } catch (err) {
      setProgress({ stage: 'error', message: 'Extraction failed', percent: 0 });
      setError(err instanceof Error ? err.message : 'Failed to extract CV');
    }
  };

  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  }, []);

  const handleDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    
    const file = e.dataTransfer.files?.[0];
    if (file) {
      processFile(file);
    }
  }, []);

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      processFile(file);
    }
  };

  const handleUseData = () => {
    if (extractedData) {
      // Update store with extracted data (keeping photoUrl empty)
      setCVData({
        personalInfo: {
          ...extractedData.personalInfo,
          photoUrl: '',
        },
        summary: extractedData.summary || '',
        workExperiences: extractedData.workExperiences || [],
        education: extractedData.education || [],
        skills: extractedData.skills || [],
        languages: extractedData.languages || [],
        certifications: extractedData.certifications || [],
        references: extractedData.references || [],
      });

      // Navigate to personal info to review
      router.push('/personal');
    }
  };

  const handleReset = () => {
    setProgress({ stage: 'idle', message: '', percent: 0 });
    setError(null);
    setExtractedData(null);
  };

  // Show extraction results
  if (extractedData) {
    return (
      <div className="space-y-6">
        <div className="text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span className="text-3xl">âœ“</span>
          </div>
          <h3 className="text-xl font-bold text-gray-900 mb-2">CV Extracted Successfully!</h3>
          <p className="text-gray-600">Review what we found below</p>
        </div>

        {/* Extraction Summary */}
        <div className="bg-gray-50 rounded-xl p-4 space-y-3">
          <ExtractedSection
            icon="ğŸ‘¤"
            title="Personal Info"
            found={!!extractedData.personalInfo?.firstName}
            details={`${extractedData.personalInfo?.firstName || ''} ${extractedData.personalInfo?.lastName || ''}`}
            confidence={extractedData.extractionConfidence?.personalInfo}
          />
          <ExtractedSection
            icon="ğŸ’¼"
            title="Work Experience"
            found={extractedData.workExperiences?.length > 0}
            details={`${extractedData.workExperiences?.length || 0} positions found`}
            confidence={extractedData.extractionConfidence?.workExperiences}
          />
          <ExtractedSection
            icon="ğŸ“"
            title="Education"
            found={extractedData.education?.length > 0}
            details={`${extractedData.education?.length || 0} qualifications found`}
            confidence={extractedData.extractionConfidence?.education}
          />
          <ExtractedSection
            icon="âš¡"
            title="Skills"
            found={extractedData.skills?.length > 0}
            details={`${extractedData.skills?.length || 0} skills found`}
            confidence={extractedData.extractionConfidence?.skills}
          />
          <ExtractedSection
            icon="ğŸŒ"
            title="Languages"
            found={extractedData.languages?.length > 0}
            details={`${extractedData.languages?.length || 0} languages found`}
          />
          <ExtractedSection
            icon="ğŸ“œ"
            title="Certifications"
            found={extractedData.certifications?.length > 0}
            details={`${extractedData.certifications?.length || 0} certifications found`}
          />
          <ExtractedSection
            icon="ğŸ“"
            title="Summary"
            found={!!extractedData.summary}
            details={extractedData.summary ? 'Found' : 'Not found - AI can generate one'}
          />
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <Button variant="outline" onClick={handleReset} className="flex-1">
            â† Upload Different CV
          </Button>
          <Button onClick={handleUseData} className="flex-1 bg-blue-600 hover:bg-blue-700">
            Use This Data â†’
          </Button>
        </div>
      </div>
    );
  }

  // Show progress
  if (progress.stage !== 'idle' && progress.stage !== 'error') {
    return (
      <div className="text-center py-8">
        <div className="w-20 h-20 mx-auto mb-6 relative">
          <svg className="w-full h-full" viewBox="0 0 100 100">
            <circle
              className="text-gray-200"
              strokeWidth="8"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
            />
            <circle
              className="text-blue-600 transition-all duration-500"
              strokeWidth="8"
              strokeDasharray={264}
              strokeDashoffset={264 - (264 * progress.percent) / 100}
              strokeLinecap="round"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
              style={{ transform: 'rotate(-90deg)', transformOrigin: '50% 50%' }}
            />
          </svg>
          <span className="absolute inset-0 flex items-center justify-center text-lg font-bold">
            {progress.percent}%
          </span>
        </div>

        <h3 className="text-lg font-semibold text-gray-900 mb-2">{progress.message}</h3>
        
        <div className="space-y-2 text-sm text-gray-500">
          <ProgressStep done={progress.percent >= 10} current={progress.stage === 'uploading'}>
            Uploading file
          </ProgressStep>
          <ProgressStep done={progress.percent >= 30} current={progress.stage === 'parsing'}>
            Reading document
          </ProgressStep>
          <ProgressStep done={progress.percent >= 60} current={progress.stage === 'extracting'}>
            Extracting with AI
          </ProgressStep>
          <ProgressStep done={progress.percent >= 90} current={progress.stage === 'processing'}>
            Organizing data
          </ProgressStep>
        </div>
      </div>
    );
  }

  // Show upload zone
  return (
    <div>
      <div
        className={`relative border-2 border-dashed rounded-xl p-8 text-center transition-all cursor-pointer ${
          isDragging
            ? 'border-blue-500 bg-blue-50'
            : 'border-gray-300 hover:border-gray-400 bg-white'
        }`}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        onClick={() => document.getElementById('cv-file-input')?.click()}
      >
        <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <span className="text-3xl">ğŸ“„</span>
        </div>

        <h3 className="text-lg font-semibold text-gray-900 mb-2">
          Drop your CV here
        </h3>
        <p className="text-gray-600 mb-4">or click to browse</p>
        
        <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
          <span className="px-2 py-1 bg-gray-100 rounded">PDF</span>
          <span className="px-2 py-1 bg-gray-100 rounded">DOCX</span>
          <span>â€¢ Max 5MB</span>
        </div>

        <input
          id="cv-file-input"
          type="file"
          accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          onChange={handleFileSelect}
          className="hidden"
        />
      </div>

      {/* Error Message */}
      {error && (
        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p className="text-red-600 text-sm flex items-center gap-2">
            <span>âš ï¸</span> {error}
          </p>
          <button
            onClick={handleReset}
            className="mt-2 text-sm text-red-600 underline hover:no-underline"
          >
            Try again
          </button>
        </div>
      )}

      {/* Info */}
      <div className="mt-6 p-4 bg-blue-50 rounded-lg">
        <h4 className="font-medium text-blue-900 mb-2">âš¡ AI-Powered Extraction</h4>
        <p className="text-sm text-blue-700">
          Our AI will automatically extract your personal info, work experience, 
          education, skills, and more. You can review and edit everything before 
          creating your new CV.
        </p>
      </div>
    </div>
  );
}

// Helper Components
function ExtractedSection({ 
  icon, 
  title, 
  found, 
  details, 
  confidence 
}: { 
  icon: string; 
  title: string; 
  found: boolean; 
  details: string;
  confidence?: number;
}) {
  return (
    <div className="flex items-center gap-3 p-3 bg-white rounded-lg">
      <span className="text-xl">{icon}</span>
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <span className="font-medium text-gray-900">{title}</span>
          {found ? (
            <span className="text-green-600 text-xs">âœ“</span>
          ) : (
            <span className="text-yellow-600 text-xs">âš </span>
          )}
        </div>
        <p className="text-sm text-gray-500 truncate">{details}</p>
      </div>
      {confidence !== undefined && (
        <div className="text-xs text-gray-400">
          {Math.round(confidence * 100)}%
        </div>
      )}
    </div>
  );
}

function ProgressStep({ 
  done, 
  current, 
  children 
}: { 
  done: boolean; 
  current: boolean; 
  children: React.ReactNode;
}) {
  return (
    <div className={`flex items-center justify-center gap-2 ${
      done ? 'text-green-600' : current ? 'text-blue-600' : 'text-gray-400'
    }`}>
      {done ? 'âœ“' : current ? 'â—' : 'â—‹'} {children}
    </div>
  );
}
```

---

### Task 4: Create Upload Page

**`src/app/upload/page.tsx`**

```tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useCVStore } from '@/stores/cv-store';
import { CVUploadZone } from '@/components/cv-upload/upload-zone';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export default function UploadPage() {
  const router = useRouter();
  const { templateId } = useCVStore();

  // Redirect to template selection if no template chosen
  useEffect(() => {
    if (!templateId) {
      router.push('/template?next=upload');
    }
  }, [templateId, router]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white">
      {/* Header */}
      <header className="bg-white border-b">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <Link href="/" className="flex items-center gap-2">
            <span className="text-xl">ğŸ“„</span>
            <span className="text-lg font-bold text-blue-600">CV Chap Chap</span>
          </Link>
          <Link href="/template" className="text-sm text-gray-600 hover:text-gray-900">
            â† Back to Templates
          </Link>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-2xl mx-auto px-4 py-12">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-3">
            Upload Your Existing CV
          </h1>
          <p className="text-gray-600 text-lg">
            We'll extract all your information and fill it into your new template automatically
          </p>
        </div>

        <Card>
          <CardContent className="p-6">
            <CVUploadZone />
          </CardContent>
        </Card>

        {/* Alternative Option */}
        <div className="mt-8 text-center">
          <p className="text-gray-500 mb-3">Don't have a CV file?</p>
          <Link 
            href="/personal"
            className="text-blue-600 hover:underline font-medium"
          >
            Start from scratch â†’
          </Link>
        </div>
      </main>
    </div>
  );
}
```

---

### Task 5: Update Template Selection Page

Add upload option to **`src/app/(builder)/template/page.tsx`**:

```tsx
// Add this after the template grid, before closing </main>

{/* Upload Option Banner */}
<div className="mt-12 bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-6 md:p-8 text-white">
  <div className="flex flex-col md:flex-row items-center justify-between gap-4">
    <div className="flex items-center gap-4">
      <div className="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
        <span className="text-3xl">ğŸ“¤</span>
      </div>
      <div>
        <h3 className="text-xl font-bold mb-1">Have an existing CV?</h3>
        <p className="text-blue-100">
          Upload it and we'll extract all your information automatically
        </p>
      </div>
    </div>
    <Button
      onClick={() => {
        if (currentTemplate) {
          router.push('/upload');
        } else {
          alert('Please select a template first');
        }
      }}
      className="bg-white text-blue-600 hover:bg-blue-50 px-6"
    >
      Upload CV â†’
    </Button>
  </div>
</div>
```

---

### Task 6: Update CV Store

Add `setCVData` method to **`src/stores/cv-store.ts`**:

```typescript
interface CVStore {
  // ... existing fields
  setCVData: (data: Partial<CVData>) => void;
}

// In the store:
setCVData: (data) => set((state) => ({
  cvData: {
    ...state.cvData,
    ...data,
    personalInfo: {
      ...state.cvData.personalInfo,
      ...data.personalInfo,
    },
  },
})),
```

---

## Summary: Files to Create/Update

| Action | File | Purpose |
|--------|------|---------|
| **Install** | `npm install pdf-parse mammoth uuid` | Dependencies |
| **Create** | `src/app/api/cv/extract/route.ts` | Extraction API |
| **Create** | `src/components/cv-upload/upload-zone.tsx` | Upload component |
| **Create** | `src/app/upload/page.tsx` | Upload page |
| **Update** | `src/app/(builder)/template/page.tsx` | Add upload banner |
| **Update** | `src/stores/cv-store.ts` | Add setCVData method |

---

## Testing Checklist

- [ ] Upload PDF CV â†’ data extracted correctly
- [ ] Upload DOCX CV â†’ data extracted correctly
- [ ] Large file (>5MB) â†’ shows error
- [ ] Invalid file type â†’ shows error
- [ ] Empty/unreadable file â†’ shows error
- [ ] Extracted data populates all form fields
- [ ] Can navigate through all steps with extracted data
- [ ] Can edit extracted data in any step
- [ ] Final preview shows all extracted + edited data
- [ ] Works on mobile

---

**This implementation will:**
1. âœ… Accept PDF and DOCX uploads
2. âœ… Extract text from documents
3. âœ… Use GPT-4 to structure the data intelligently
4. âœ… Show extraction progress with visual feedback
5. âœ… Display what was found before committing
6. âœ… Populate the entire CV builder with extracted data
7. âœ… Allow editing at any step